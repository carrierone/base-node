version: '3.8'

services:
  base-op-node:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      --l1=http://192.168.7.17:8545
      --l2=http://base-execution:8545
      --l2.jwt-secret=/data/jwt.txt
      --l1.beacon=http://192.168.7.18:5052
      --rollup.config=/data/rollup.json
      --rpc.addr=0.0.0.0
      --rpc.port=8545
      --p2p.listen.ip=0.0.0.0
      --p2p.listen.tcp=9222
      --p2p.listen.udp=9223
      --metrics.enabled
      --metrics.addr=0.0.0.0
      --metrics.port=7300
      --p2p.priv.path=/data/priv.txt
    volumes:
      - base_op_node_data:/data
    networks:
      ipvlan_ens2f0np0:
        ipv4_address: 192.168.7.35
    ports:
      - "7545:8545"
      - "9223:9222"
      - "9223:9222/udp"
      - "7302:7300"
      - "6061:6060"
    depends_on:
      - base-execution
    restart: unless-stopped

  base-execution:
    build:
      context: .
      dockerfile: Dockerfile.nethermind
    entrypoint: ["/snapshot-download.sh"]
    command: ["--config", "base"]
    environment:
      - NETHERMIND_L1_RPC_URL=http://192.168.7.17:8545
      - NETHERMIND_L1_BEACON_URL=http://192.168.7.18:5052
      - JsonRpc.Enabled=true
      - JsonRpc.Host=0.0.0.0
      - JsonRpc.Port=8545
      - JsonRpc.CorsOrigins=*
      - JsonRpc.EnabledModules=eth,net,web3,debug,optimism
      - Optimism.Enabled=true
      - Optimism.SequencerUrl=https://mainnet-sequencer.base.org
      - Database.Path=/data
      - Sync.Snap=true
      - Network.DiscoveryPort=30304
      - Network.P2PPort=30304
    volumes:
      - base_execution_data:/data
    networks:
      - default
    ports:
      - "8547:8545"
      - "30304:30304"
      - "30304:30304/udp"
      - "7303:6060"
    restart: unless-stopped

volumes:
  base_op_node_data:
  base_execution_data:

networks:
  default:
    driver: bridge
  ipvlan_ens2f0np0:
    driver: ipvlan
    external: true
    driver_opts:
      parent: ens2f0np0
      ipvlan_mode: l3
